# 🏆 Chase游戏云端分数系统集成指南

## 📋 **系统概述**

成功替换Firebase，使用**Cloudflare D1数据库 + Workers API**实现了完整的云端分数管理系统：

- ✅ **无需注册登录** - 基于设备ID的用户识别
- ✅ **云端分数同步** - 自动上传最高分到云端
- ✅ **全球排行榜** - 实时查看全球玩家排名
- ✅ **玩家昵称系统** - 自定义玩家显示名称
- ✅ **本地+云端双备份** - 数据更安全

## 🔧 **已创建的脚本**

### 1. **CloudScoreManager.cs** - 云端分数管理核心
- 处理与Cloudflare API的所有网络通信
- 自动获取设备唯一ID
- 管理玩家昵称存储
- 提供分数提交、排行榜查询等功能

### 2. **修改后的GameManager.cs** - 游戏管理器升级
- 集成云端分数管理
- 同时维护本地和云端最高分记录
- 游戏结束时自动提交分数到云端

### 3. **PlayerNameUI.cs** - 玩家昵称管理
- 提供昵称输入界面
- 昵称验证和过滤
- 支持键盘快捷键操作

### 4. **LeaderboardUI.cs** - 排行榜显示系统
- 动态加载和显示排行榜
- 自动创建排行榜条目
- 前三名特殊颜色显示

## 🎮 **Unity集成步骤**

### **步骤1：添加脚本到场景**

1. **创建CloudScoreManager对象**：
   ```
   - 在场景中创建空GameObject，命名为"CloudScoreManager"
   - 添加CloudScoreManager.cs脚本
   - 设置API Base URL为：https://chase-game-api.kkjusdoit.workers.dev
   ```

2. **修改GameManager设置**：
   ```
   - 在GameManager中找到"云端分数"部分
   - 将CloudScoreManager对象拖拽到cloudScoreManager字段
   - 添加一个Text组件作为cloudScoreText（显示云端最高分）
   ```

### **步骤2：添加UI元素**

#### **玩家昵称UI**：
```
创建昵称输入面板：
├── NameInputPanel (GameObject)
    ├── Background (Image - 半透明背景)
    ├── NameInputField (InputField - 昵称输入框)
    ├── SaveButton (Button - 保存按钮)
    ├── CancelButton (Button - 取消按钮)
    └── Title (Text - "设置昵称"标题)

创建昵称显示：
├── CurrentNameText (Text - 点击可编辑昵称)
```

#### **排行榜UI**：
```
创建排行榜面板：
├── LeaderboardPanel (GameObject)
    ├── Background (Image - 面板背景)
    ├── Title (Text - "排行榜"标题)
    ├── ScrollView (ScrollRect)
    │   └── Content (Transform - 排行榜内容容器)
    ├── RefreshButton (Button - 刷新按钮)
    ├── CloseButton (Button - 关闭按钮)
    ├── LoadingText (Text - "加载中..."提示)
    ├── ErrorText (Text - 错误信息显示)
    └── NoDataText (Text - "暂无数据"提示)

创建排行榜入口：
├── ShowLeaderboardButton (Button - "查看排行榜"按钮)
```

### **步骤3：脚本配置**

#### **CloudScoreManager配置**：
- ✅ **API Base URL**: `https://chase-game-api.kkjusdoit.workers.dev`
- ✅ **Enable Debug Logs**: 勾选（用于调试）

#### **PlayerNameUI配置**：
- 将所有UI元素拖拽到对应字段
- 设置**Max Name Length**: `20`
- 设置**Default Name**: `"Anonymous"`

#### **LeaderboardUI配置**：
- 将排行榜相关UI元素拖拽到对应字段
- 设置**Max Entries**: `10`
- 勾选**Auto Refresh On Show**

## 🚀 **功能使用说明**

### **分数自动同步**
- 🎯 **游戏结束时**：自动提交当前分数到云端
- 📊 **本地记录更新**：如果超过本地最高分，更新本地记录
- ☁️ **云端记录更新**：如果超过云端最高分，更新云端记录
- 🔄 **双重保障**：本地和云端分数独立维护

### **玩家昵称系统**
- 👤 **点击昵称文本**：打开昵称编辑面板
- ⌨️ **键盘操作**：Enter保存，Escape取消
- 🎮 **游戏暂停**：编辑昵称时自动暂停游戏
- 💾 **自动保存**：昵称保存到本地，提交分数时同步到云端

### **排行榜查看**
- 🏆 **实时排名**：显示全球前10名玩家
- 🥇 **特殊标识**：前三名使用特殊颜色（金、银、铜）
- 🔄 **手动刷新**：点击刷新按钮更新排行榜
- ⏱️ **防刷保护**：5秒内只能刷新一次

## 🔍 **调试和监控**

### **Console日志**
启用Debug Logs后，可以在Unity Console中看到：
```
[CloudScoreManager] Device ID: 设备唯一标识符
[CloudScoreManager] API connection successful!
[CloudScoreManager] Submitting score: 100 for player: YourName
[CloudScoreManager] New high score recorded!
[CloudScoreManager] Leaderboard loaded with 5 entries
```

### **网络状态监控**
- ✅ **连接成功**：Console显示"API connection successful!"
- ❌ **连接失败**：错误信息会显示在ErrorText中
- 🔄 **重试机制**：网络错误时可以手动重试

## 📊 **数据库结构**

云端数据库表格 `leaderboard`：
```sql
id          INTEGER PRIMARY KEY AUTOINCREMENT
device_id   TEXT NOT NULL           -- 设备唯一标识
player_name TEXT DEFAULT 'Anonymous' -- 玩家昵称  
best_score  INTEGER DEFAULT 0       -- 最高分数
created_at  TEXT DEFAULT CURRENT_TIMESTAMP -- 创建时间
updated_at  TEXT DEFAULT CURRENT_TIMESTAMP -- 更新时间
```

## 🔧 **API端点说明**

### **1. 提交分数**
```
POST /submit-score
Body: {
  "device_id": "设备ID",
  "player_name": "玩家昵称", 
  "score": 123
}
```

### **2. 获取排行榜**
```
GET /leaderboard?limit=10
Response: {
  "success": true,
  "count": 5,
  "leaderboard": [...]
}
```

### **3. 获取玩家分数**
```
GET /player-score/{device_id}
Response: {
  "success": true,
  "player": {...}
}
```

## 🎯 **用户体验流程**

1. **首次游戏**：
   - 系统自动生成设备ID
   - 使用默认昵称"Anonymous"
   - 分数提交到云端

2. **设置昵称**：
   - 点击昵称文本进入编辑模式
   - 输入个性化昵称
   - 后续分数以新昵称显示在排行榜

3. **查看排名**：
   - 点击"排行榜"按钮
   - 查看全球前10名
   - 找到自己的排名位置

4. **继续游戏**：
   - 本地最高分和云端最高分分别显示
   - 目标是超越云端最高分创造新记录

## 🚨 **注意事项**

- 📱 **网络连接**：需要网络连接才能使用云端功能
- 🔄 **离线游戏**：没有网络时仍可正常游戏，只是无法同步云端分数
- 🎮 **设备绑定**：云端分数与设备绑定，更换设备需要重新开始
- 🛡️ **数据安全**：本地分数和云端分数独立存储，不会丢失

---

**🎉 恭喜！你的Chase游戏现在拥有了完整的云端分数系统！**

无需复杂的用户注册，玩家可以立即开始游戏并与全球玩家竞争！ 